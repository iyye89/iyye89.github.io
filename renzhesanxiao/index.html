<!doctype html>
<html>
	<head>

		<meta charset="UTF-8" />
		<title>忍者消消看</title>
		<style>
          	body{
				margin:0;
				padding:0;
			}
          </style>
		  
		<script src="phaser.min.js"></script>
		<!-- 
		<script type="text/javascript" src="js/Juicy.js"></script>
		-->
		<script type="text/javascript" src="js/Juicy.js"></script>
		<script type="text/javascript">
		 
			
			/*
			Match-3 Action Puzzle Game Prototype
			*/
			
			
			var game = new Phaser.Game(600,900,Phaser.CANVAS,"",{preload:onPreload, create:onCreate, update:onUpdate});
			

			var tileSize = 100;                	// tile size, in pixels
			var fieldSize = 6;				// Number of columns
			var fieldSizeB = 6;			//Number of rows
			var tileTypes = 7;                 // different kind of tiles allowed
			var tileArray = [];                // array with all game tiles
			
			var quantiCancello=0;
			
			var shifter=300; //Alway a multiple of the tilesize value
			
			var flagAttack=0;
			
			var explosions;
			
			var enemy = new Array();
			var howmanyEnemy=0;
			
			
			var enemyGamma = new Array();
			var howmanyenemyGamma=0;
			
			
			var monster3 = new Array()
			var howmanyMonster3=0;
			
			var incrPosMonster4=30;
			
			var ouch=0;
			var death=0;
			var characterEnergy=1;
			var points=0;

			//step=0 (menu)
			//step=1 (change assets positions)
			//step=2 (game)
			var step=0;
			
			var deathTimer;
			
			if(!localStorage["score"]) localStorage["score"]=0;
			
			
			//Here we choose our avatar
			// 0 Robot
			// 1 CowGirl
			// 2 Ninja
			// 3 NinjaGirl
			var wichChar;
			if(!localStorage["character"]) localStorage["character"] = 2;
		    	if(localStorage["character"]==0) wichChar=1;//(they are inverted....)
		    	if(localStorage["character"]==1) wichChar=0;//(they are inverted....)
		    	if(localStorage["character"]==2) wichChar=2;
		    	if(localStorage["character"]==3) wichChar=3;
		    				
			//wichChar=2;
			//Here we choose our world
			var wichWorld;
			if(!localStorage["world"]) localStorage["world"] = 1;
		    	//wichWorld=Math.floor(localStorage["world"]+1);
		    	if(localStorage["world"]==0) wichWorld=1;
		    	if(localStorage["world"]==1) wichWorld=2;
		    	if(localStorage["world"]==2) wichWorld=3;
		    	if(localStorage["world"]==3) wichWorld=4;
		    	if(localStorage["world"]==4) wichWorld=5;
			//wichWorld=2;
			
			
			//Here we choose the blocks
			var wichBlocks;
			if(!localStorage["block"]) localStorage["block"] = 1;
		    	//wichBlocks=Math.floor(localStorage["block"]+1);
		    	if(localStorage["block"]==0) wichBlocks=1;
		    	if(localStorage["block"]==1) wichBlocks=2;
		    	if(localStorage["block"]==2) wichBlocks=3;
		    	if(localStorage["block"]==3) wichBlocks=4;
		    	if(localStorage["block"]==4) wichBlocks=5;
		    	if(localStorage["block"]==5) wichBlocks=6;
		    	if(localStorage["block"]==6) wichBlocks=7;
		    	if(localStorage["block"]==7) wichBlocks=8;
		    	if(localStorage["block"]==8) wichBlocks=9;
		    	if(localStorage["block"]==9) wichBlocks=10;
			//wichBlocks=2;
			
			// Check the platform
			// if mobile, we change the speed
			// of weapons and enemies (there are some
			// problems with tweens on mobile)
			var tablet=0;
			var ua = navigator.userAgent.toLowerCase();
			var isAndroid = ua.indexOf("android") > -1; 
			if(isAndroid) {
				tablet=1;
			}
			var isIosD = ua.indexOf("ipad") > -1; 
			if(isIosD) {
				tablet=1;
			}
			var isIosP = ua.indexOf("phone") > -1; 
			if(isIosP) {
				tablet=1;
			}
			
			
			
			

			// on preloading, preload the graphics and enable scale mode
               function onPreload() {
				//game.load.spritesheet("tiles","assets/tiles.png",35,35);
				//game.stage.backgroundColor = '#34495e';
				labelLoading = game.add.text(200, 100, 'loading...', { font: '40px Arial', fill: '#fff' });
				labelLoading.anchor.setTo(0.5, 0.5);
				
				
				game.stage.backgroundColor = '#000000';
				
				//Desert
				if(wichWorld==1){
				
					game.load.image("background", "assets/worlds/desert/bg-desert.png");
					game.load.spritesheet("enemy","assets/worlds/desert/enemy.png",50,58);
					game.load.spritesheet("enemyAlfa","assets/worlds/desert/enemy3_100X100.png",100,100);
					game.load.spritesheet("enemyGamma","assets/worlds/desert/enemy6_40X36-5.png",40,36.5);
					//Uncomment
					game.load.audio('bgmusic', ['assets/musics/Discovering_New_Frontiers_110_BPM_.ogg']);
				
				}
				//Robot
				if(wichWorld==2){
				
					game.load.image("background", "assets/worlds/robot/city_background_sunset.png");
					game.load.spritesheet("enemy","assets/worlds/robot/robot-go_75x74.png",75,74);
					game.load.spritesheet("enemyAlfa","assets/worlds/robot/robotbig_150x150.png",150,150);
					game.load.image("enemyGamma","assets/worlds/robot/boulder.png");
					//Uncomment
					game.load.audio('bgmusic', ['assets/musics/Do_you_like_FM.ogg']);
				
				}
				//Monster
				if(wichWorld==3){
				
					game.load.image("background", "assets/worlds/monster/swamp.png");
					game.load.spritesheet("enemy","assets/worlds/monster/mns_50x54.png",50,54);
					game.load.image("enemyAlfa","assets/worlds/monster/spiky-monster.png");
					game.load.spritesheet("enemyGamma","assets/worlds/monster/ms_50x59.png",50,59);
					//Uncomment
					game.load.audio('bgmusic', ['assets/musics/Bouncy_0.ogg']);
					
				
				}
				//Horror
				if(wichWorld==4){
				
					game.load.image("background", "assets/worlds/horror/monster-bkg.png");
					game.load.spritesheet("enemy","assets/worlds/horror/golem_100x77.png",100,77);
					game.load.spritesheet("enemyAlfa","assets/worlds/horror/skel-go_92x150.png",92,150);
					game.load.image("enemyGamma","assets/worlds/horror/mn_30x36.png");
					//Uncomment
					game.load.audio('bgmusic', ['assets/musics/The_sleeping_funk.ogg']);
				
				}
				//Ninja
				if(wichWorld==5){
				
					game.load.image("background", "assets/worlds/ninja/ninja-bkg1.png");
					game.load.spritesheet("enemy","assets/worlds/ninja/zid_30x40.png",30,40);
					game.load.image("enemyAlfa","assets/worlds/ninja/mn_150x147.png");
					game.load.spritesheet("enemyGamma","assets/worlds/ninja/st_50x56.png",50,56);
					//Uncomment
					game.load.audio('bgmusic', ['assets/musics/Blackmoor_Ninjas.ogg']);
				
				}
				
				
				//game.load.audio('bgmusic', ['assets/sky.ogg']);
				
				
				//All fx
				game.load.audio('attack', ['assets/fx/NFF-kid-attack.ogg']);
				game.load.audio('yahoo', ['assets/fx/NFF-yahoo.ogg']);
				game.load.audio('bump', ['assets/fx/NFF-bump-wood.ogg']);
				game.load.audio('throw', ['assets/fx/NFF-throw-05.ogg']);
				
				
				

				game.load.image("buttonmenu", "assets/ui/play.png");
				game.load.image("buttonpref", "assets/ui/pref.png");
				game.load.image("bkgmenu", "assets/ui/w0.png");
				game.load.image("windowmenu", "assets/ui/w1.png");
				
				
				game.load.image("credits1", "credits/bkg-credits-def.png");
				game.load.image("credits2", "credits/bkg-credits-def-music.png");
				game.load.image("creditsbutton", "credits/credits.png");
				
				//game.load.image("elve_bar", "assets/elve_bar.png");
				game.load.image("elve_bar", "assets/ui/blood.png");
				//game.load.image("elve_bar", "assets/blood_bar.png");
				game.load.image("rock_bar", "assets/ui/rock_bar.png");
				game.load.image("back", "assets/ui/back_small.png");
				
				
				
				//Different tiles for the selected blocks group
				if(wichBlocks==0) game.load.spritesheet("tiles","assets/blocks/all_35x35_7blocks.png",100,100);
				if(wichBlocks==10) game.load.spritesheet("tiles","assets/blocks/mm_35x35.png",100,100);
				if(wichBlocks==9) game.load.spritesheet("tiles","assets/blocks/lollipop_35x35.png",100,100);
				if(wichBlocks==8) game.load.spritesheet("tiles","assets/blocks/jelly_35x35.png",100,100);
				if(wichBlocks==7) game.load.spritesheet("tiles","assets/blocks/gems2_35x35.png",100,100);
				if(wichBlocks==6) game.load.spritesheet("tiles","assets/blocks/gems1_35x35.png",100,100);
				if(wichBlocks==5) game.load.spritesheet("tiles","assets/blocks/blocks2_35x35.png",100,100);
				if(wichBlocks==4) game.load.spritesheet("tiles","assets/blocks/balloon_35x35.png",100,100);
				if(wichBlocks==3) game.load.spritesheet("tiles","assets/blocks/animal_35x35.png",100,100);
				if(wichBlocks==2) game.load.spritesheet("tiles","assets/blocks/all_35x35_7blocks.png",100,100);
				if(wichBlocks==1) game.load.spritesheet("tiles","assets/blocks/mushrooms_35x35.png",100,100);
				
				
				
				game.load.spritesheet("character", "assets/avatar/spritesheet_wip2.png",200,169);
				game.load.spritesheet("character_robot", "assets/avatar/spritesheet_wip2_robot.png",200,169);
				game.load.spritesheet("character_ninja", "assets/avatar/spritesheet_wip2_ninja.png",200,169);
				game.load.spritesheet("character_ninjagirl", "assets/avatar/spritesheet_wip2_ninjagirl.png",200,169);
				
				game.load.spritesheet("explosion", 'assets/weapons/explosion.png', 128, 128);
				
				//Different weapons for each character
				//wichChar=0
				game.load.image("bullet_char0", "assets/weapons/bullet_robot.png");
				game.load.spritesheet("monster1_char0", 'assets/weapons/bullet_robot2.png', 172, 139);
				game.load.spritesheet("monster2_char0", 'assets/weapons/bullet_robot_50x40-5frames.png', 50, 40);
				game.load.spritesheet("monster3_char0", 'assets/weapons/bullet_robot_50x40-5frames.png', 50, 40);
				game.load.spritesheet("monster4_char0", 'assets/weapons/bullet_robot_50x40-5frames.png', 50, 40);
				//wichChar=1
				game.load.image("bullet_char1", "assets/weapons/bullet.png");
				game.load.spritesheet("monster1_char1", 'assets/weapons/final-monster1_80X81-25.png', 80, 81.25);
				game.load.spritesheet("monster2_char1", 'assets/weapons/final-monster2_80X58-5.png', 80, 58.5);
				game.load.spritesheet("monster3_char1", 'assets/weapons/final-monster3_55X45.png', 55, 45);
				game.load.spritesheet("monster4_char1", 'assets/weapons/final-monster4_30X27-5.png', 30, 27.5);
				//wichChar=2
				game.load.image("bullet_char2", "assets/weapons/Kunai_small.png");
				game.load.image("monster1_char2", 'assets/weapons/Kunai.png');
				game.load.image("monster2_char2", 'assets/weapons/Kunai_small.png');
				game.load.image("monster3_char2", 'assets/weapons/Kunai_small.png');
				game.load.image("monster4_char2", 'assets/weapons/Kunai_small.png');
				//wichChar=3
				game.load.image("bullet_char3", "assets/weapons/Kunai_small_girl.png");
				game.load.image("monster1_char3", 'assets/weapons/Kunai_girl.png');
				game.load.image("monster2_char3", 'assets/weapons/Kunai_small_girl.png');
				game.load.image("monster3_char3", 'assets/weapons/Kunai_small_girl.png');
				game.load.image("monster4_char3", 'assets/weapons/Kunai_small_girl.png');

				game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
				game.scale.setScreenSize(true);
			}
			
			
			
		function manageEnergy(damage){
				if(death==0){
					
					//Jelly del character
					game.juicy.jelly(character);
					//Lo shake
					game.juicy.shake();
					//Un flash dello sfondo delle gemme (il flash dello schermo necessita che non vi sia uno 
					//sfondo disegnato ma un colore di base)
					game.screenFlash.flash(1,100);
					
					characterEnergy-=damage;
					//characterEnergy-=0.5;
					if(characterEnergy<0){ 
						characterEnergy=0;
						death=1;
					}
					elve_bar.scale.setTo(characterEnergy, 1);
				}
		
		}	
		
		function managePoints(howPointsAdd){
		
			//Increase the XP
			points+=howPointsAdd;												
			tpoints.setText('Points: '+points);
		
		}
			
			
               // when the game is created, generate the tiles
			function onCreate(){
				
				//Juicy--------------------
				//Juicified mode da usare solo su schermo ad inquadratura fissa
				//su sistemi con camera che segue il player genera casini
				//inoltre il flash dello schermo necessita che non vi sia uno 
				//sfondo disegnato ma un colore di base
				game.juicy = game.plugins.add(new Phaser.Plugin.Juicy(this));
				game.screenFlash = game.juicy.createScreenFlash();
				game.add.existing(game.screenFlash);
				//-------------------------
				
				
				
				
				
				//background = game.add.sprite(0, 0, 'background');
				//game.physics.arcade.enableBody(background);
				//background.anchor.setTo(0, 0);
				
				//  The scrolling background
    				starfield = game.add.tileSprite(0, 0, 600, 300, 'background');
				
				
				
				
				//Uncomment
				music = game.add.sound('bgmusic',1,true);
				//FX
				attack = game.add.sound('attack');
				yahoo = game.add.sound('yahoo');
				bump = game.add.sound('bump');
				attackshot = game.add.sound('throw');
				//eg. attack.play('',0,1,false);

				//music.play('',0,1,true);
				
				
				
				
				
				//character = game.add.sprite(300, 530, 'character');

				//game.physics.arcade.enableBody(character);
				//character.anchor.setTo(0.5, 0.5);
				
				if(wichChar==0){
				
					character = game.add.sprite(300, 530, 'character_robot');

					game.physics.arcade.enableBody(character);
					character.anchor.setTo(0.5, 0.5);
					
					character.animations.add('dead',[0,1,2,3,4,5,6,7,8,9], 10 /*fps */, false);
					character.animations.add('finaldead',[9,9], 1 /*fps */, true);
					character.animations.add('ouch',[0,1,0], 10 /*fps */, false);
					character.animations.add('idle',[10,11,12,13,14,15,16,17,18,19], 10 /*fps */, true);
					character.animations.add('melee',[20,21,22,23,24,25,26], 10 /*fps */, false);
					character.animations.add('shot',[27,28,29], 15 /*fps */, true);
					character.animations.add('run',[30,31,32,33,34,35,36,37], 15 /*fps */, true);
					//character.animations.add('shotb',[27,28,29,27,28,29], 10 /*fps */, false);
					//character.animations.add('shotc',[27,28,29,27,28,29,27,28,29], 10 /*fps */, false);
					//character.animations.play('run');
					character.animations.play('idle');
				
				}
				if(wichChar==1){
				
					character = game.add.sprite(300, 530, 'character');

					game.physics.arcade.enableBody(character);
					character.anchor.setTo(0.5, 0.5);
					
					character.animations.add('dead',[0,1,2,3,4,5,6,7,8,9], 10 /*fps */, false);
					character.animations.add('finaldead',[9,9], 1 /*fps */, true);
					character.animations.add('ouch',[0,1,0], 10 /*fps */, false);
					character.animations.add('idle',[10,11,12,13,14,15,16,17,18,19], 10 /*fps */, true);
					character.animations.add('melee',[20,21,22,23,24,25,26], 10 /*fps */, false);
					character.animations.add('shot',[27,28,29], 15 /*fps */, true);
					character.animations.add('run',[30,31,32,33,34,35,36,37], 15 /*fps */, true);
					//character.animations.add('shotb',[27,28,29,27,28,29], 10 /*fps */, false);
					//character.animations.add('shotc',[27,28,29,27,28,29,27,28,29], 10 /*fps */, false);
					//character.animations.play('run');
					character.animations.play('idle');
				
				}
				else if(wichChar==2){
				
					character = game.add.sprite(350, 520, 'character_ninja');

					game.physics.arcade.enableBody(character);
					character.anchor.setTo(0.5, 0.5);
					
					character.animations.add('dead',[0,1,2,3,4,5,6,7,8,9], 10 /*fps */, false);
					character.animations.add('finaldead',[9,9], 1 /*fps */, true);
					character.animations.add('ouch',[0,1,0], 10 /*fps */, false);
					character.animations.add('idle',[10,11,12,13,14,15,16,17,18,19], 10 /*fps */, true);
					character.animations.add('melee',[20,21,22,23,24,25,26,27,28,29], 15 /*fps */, false);
					character.animations.add('shot',[30,31,32,33,34,35,36,37,38,39], 20 /*fps */, true);
					character.animations.add('run',[40,41,42,43,44,45,46,47,48,49], 15 /*fps */, true);
					//character.animations.add('shotb',[27,28,29,27,28,29], 10 /*fps */, false);
					//character.animations.add('shotc',[27,28,29,27,28,29,27,28,29], 10 /*fps */, false);
					//character.animations.play('run');
					character.animations.play('idle');
				
				}
				else if(wichChar==3){
				
					character = game.add.sprite(350, 520, 'character_ninjagirl');

					game.physics.arcade.enableBody(character);
					character.anchor.setTo(0.5, 0.5);
					
					character.animations.add('dead',[0,1,2,3,4,5,6,7,8,9], 10 /*fps */, false);
					character.animations.add('finaldead',[9,9], 1 /*fps */, true);
					character.animations.add('ouch',[0,1,0], 10 /*fps */, false);
					character.animations.add('idle',[10,11,12,13,14,15,16,17,18,19], 10 /*fps */, true);
					character.animations.add('melee',[20,21,22,23,24,25,26,27,28,29], 15 /*fps */, false);
					character.animations.add('shot',[30,31,32,33,34,35,36,37,38,39], 20 /*fps */, true);
					character.animations.add('run',[40,41,42,43,44,45,46,47,48,49], 15 /*fps */, true);
					//character.animations.add('shotb',[27,28,29,27,28,29], 10 /*fps */, false);
					//character.animations.add('shotc',[27,28,29,27,28,29,27,28,29], 10 /*fps */, false);
					//character.animations.play('run');
					character.animations.play('idle');
				
				}
				
				
				for(i=0;i<fieldSizeB;i++){
					tileArray[i]=[];
					for(j=0;j<fieldSize;j++){
						var randomTile = Math.floor(Math.random()*tileTypes)
						theTile=game.add.sprite(j*tileSize+tileSize/2,(i*tileSize+tileSize/2)+shifter,"tiles");
						theTile.frame = randomTile;
						theTile.anchor.setTo(0.5,0.5);
						tileArray[i][j]=theTile;
					}
				}
				//game.input.onDown.add(pickTile, this);
				
				
				
				//GUI - rock bar for background
				rock_bar = game.add.sprite(-1, -1, 'rock_bar');
				game.physics.arcade.enableBody(rock_bar);
				rock_bar.anchor.setTo(0, 0);
				//GUI - elve bar for life
				elve_bar = game.add.sprite(8, 8, 'elve_bar');
				game.physics.arcade.enableBody(elve_bar);
				elve_bar.anchor.setTo(0, 0);
				
				
				
				exitbutton = this.add.button(540, 10, 'back', function () {
						
						
						if(points>localStorage["score"]) localStorage["score"]=points;
		

			    	}, this);
				
				//GUI - show the XP
			    	//var styleP = {font: '25px Arial', fill: '#fbba2f', align: 'left', fontWeight: 'bold', stroke: '#000000', strokeThickness: 6};
			    	var styleP = {font: '25px Arial', fill: '#ffffff', align: 'left', fontWeight: 'bold', stroke: '#000000', strokeThickness: 4};
			    	tpoints = game.add.text(310,2, 'Points: '+points, styleP);
			    	tpoints.inputEnabled = true;
			    	
				
				
				
				
			    //  Our bullet group
			    bullets = game.add.group();
			    bullets.enableBody = true;
			    bullets.physicsBodyType = Phaser.Physics.ARCADE;
			    if(wichChar==0) bullets.createMultiple(30, 'bullet_char0');
			    if(wichChar==1) bullets.createMultiple(30, 'bullet_char1');
			    if(wichChar==2) bullets.createMultiple(30, 'bullet_char2');
			    if(wichChar==3) bullets.createMultiple(30, 'bullet_char3');
			    bullets.scaleSpeed = 1000;
			    bullets.setAll('anchor.x', 0.5);
			    bullets.setAll('anchor.y', 1);
			    bullets.setAll('outOfBoundsKill', true);
			    bullets.setAll('checkWorldBounds', true);
			    //Step3
			    //bullets.setAll('tracking', true);
			    
			    
			    
			    
			    //  Our monster1 group
			    monsters1 = game.add.group();
			    monsters1.enableBody = true;
			    monsters1.physicsBodyType = Phaser.Physics.ARCADE;
			    if(wichChar==0) monsters1.createMultiple(30, 'monster1_char0');
			    if(wichChar==1) monsters1.createMultiple(30, 'monster1_char1');
			    if(wichChar==2) monsters1.createMultiple(30, 'monster1_char2');
			    if(wichChar==3) monsters1.createMultiple(30, 'monster1_char3');
			    monsters1.scaleSpeed = 1000;
			    monsters1.setAll('anchor.x', 0.5);
			    monsters1.setAll('anchor.y', 1);
			    monsters1.setAll('outOfBoundsKill', true);
			    monsters1.setAll('checkWorldBounds', true);
			    
			    
			    //  Our monster2 group
			    monsters2 = game.add.group();
			    monsters2.enableBody = true;
			    monsters2.physicsBodyType = Phaser.Physics.ARCADE;
			    if(wichChar==0) monsters2.createMultiple(30, 'monster2_char0');
			    if(wichChar==1) monsters2.createMultiple(30, 'monster2_char1');
			    if(wichChar==2) monsters2.createMultiple(30, 'monster2_char2');
			    if(wichChar==3) monsters2.createMultiple(30, 'monster2_char3');
			    monsters2.scaleSpeed = 1000;
			    monsters2.setAll('anchor.x', 0.5);
			    monsters2.setAll('anchor.y', 1);
			    monsters2.setAll('outOfBoundsKill', true);
			    monsters2.setAll('checkWorldBounds', true);
			    
			    
			    //  Our monster3 array
			    for(e=0;e<=10;e++){
				    if(wichChar==0) monster3[e] = game.add.sprite(character.x-1000, character.y-1000, 'monster3_char0');
				    if(wichChar==1) monster3[e] = game.add.sprite(character.x-1000, character.y-1000, 'monster3_char1');
				    if(wichChar==2) monster3[e] = game.add.sprite(character.x-1000, character.y-1000, 'monster3_char2');
				    if(wichChar==3) monster3[e] = game.add.sprite(character.x-1000, character.y-1000, 'monster3_char3');
				    game.physics.arcade.enable(monster3[e]);
				    monster3[e].enableBody = true;
			    }
			    
			    
			    //  Our monster4 group
			    monsters4 = game.add.group();
			    monsters4.enableBody = true;
			    monsters4.physicsBodyType = Phaser.Physics.ARCADE;
			    if(wichChar==0) monsters4.createMultiple(30, 'monster4_char0');
			    if(wichChar==1) monsters4.createMultiple(30, 'monster4_char1');
			    if(wichChar==2) monsters4.createMultiple(30, 'monster4_char2');
			    if(wichChar==3) monsters4.createMultiple(30, 'monster4_char3');
			    monsters4.scaleSpeed = 1000;
			    monsters4.setAll('anchor.x', 0.5);
			    monsters4.setAll('anchor.y', 1);
			    monsters4.setAll('outOfBoundsKill', true);
			    monsters4.setAll('checkWorldBounds', true);
			    
			    
			    
			    
			    
			    //  Our enemy2 group
			    enemies2 = game.add.group();
			    enemies2.enableBody = true;
			    enemies2.physicsBodyType = Phaser.Physics.ARCADE;
			    enemies2.createMultiple(30, 'enemyAlfa');
			    enemies2.scaleSpeed = 1000;
			    enemies2.setAll('anchor.x', 0.5);
			    enemies2.setAll('anchor.y', 1);
			    enemies2.setAll('outOfBoundsKill', true);
			    enemies2.setAll('checkWorldBounds', true);
			    
			    
			    
			    
			    
			    //  An explosion pool
			    explosions = game.add.group();
			    explosions.enableBody = true;
			    explosions.physicsBodyType = Phaser.Physics.ARCADE;
			    explosions.createMultiple(30, 'explosion');
			    explosions.setAll('anchor.x', 0.5);
			    explosions.setAll('anchor.y', 1);
			    explosions.setAll('outOfBoundsKill', true);
			    explosions.setAll('checkWorldBounds', true);
			    //explosions.forEach(setupInvader, this);
				
				
				bkgmenu = game.add.sprite(0, 0, 'bkgmenu');
				game.physics.arcade.enableBody(bkgmenu);
				
				
				//var styleTitle = {font: '75px Arial', fill: '#fbba2f', align: 'left', fontWeight: 'bold', stroke: '#000000', strokeThickness: 9};
				var styleTitle = {font: '65px Arial', fill: '#CC0099', align: 'center', fontWeight: 'bold', stroke: '#ffffff', strokeThickness: 9};
			    	//title = game.add.text(170,20, 'ACTION \r JEWEL', styleTitle);
			    	title = game.add.text(80,20, 'Coffee Break\rMatch 3', styleTitle);
			    	title.inputEnabled = true;
			    	
			    	
			    	var styleScore = {font: '40px Arial', fill: '#ff0000', align: 'left', fontWeight: 'bold', stroke: '#ffffff', strokeThickness: 9};
			    	myscore = game.add.text(100,200, 'Best score: '+localStorage["score"], styleScore);
			    	myscore.inputEnabled = true;
			    	
			    	
				
				windowmenu = game.add.sprite(75, 250, 'windowmenu');
				game.physics.arcade.enableBody(windowmenu);
				/*
				buttonmenu = game.add.sprite(118, 600, 'buttonmenu');
				game.physics.arcade.enableBody(buttonmenu);
				*/
				character.bringToTop();
				
				
				playbutton = this.add.button(70, 650, 'buttonmenu', function () {
						
						step=1;
						//Uncomment
						music.play('',0,1,true);


			    	}, this);
			    	
			    	preferencesbutton = this.add.button(350, 650, 'buttonpref', function () {
						
						

			    	}, this);
				   
				creditsbutton = this.add.button(480, 10, 'creditsbutton', function () {
						
//						credits1.x=0;
//						credits1.y=0;

			    	}, this);
			    	
			    	
			    	credits1 = this.add.button(-1000, -1000, 'credits1', function () {
						
//						credits2.x=0;
//						credits2.y=0;

			    	}, this);
			    	
			    	credits2 = this.add.button(-1000, -1000, 'credits2', function () {
						
						credits1.x=-1000;
						credits1.y=-1000;
						
						credits2.x=-1000;
						credits2.y=-1000;

			    	}, this);
				
				//We manage enemies
				game.time.events.loop(3500, function () {
	   				
	   				if(step==2){
	   				
		   				if(howmanyEnemy<=30){
					   		enemy[howmanyEnemy] = game.add.sprite(610, 0, 'enemy');
							game.physics.arcade.enable(enemy[howmanyEnemy]);
							enemy[howmanyEnemy].enableBody = true;
							enemy[howmanyEnemy].anchor.setTo(0.5, 0.5);
							
							if(tablet==1) enemy[howmanyEnemy].body.velocity.x = -150;
							else enemy[howmanyEnemy].body.velocity.x = -50;
							
							if(wichWorld==1) enemy[howmanyEnemy].animations.add('walk',[0,1], 5 /*fps */, true);
							if(wichWorld==1) enemy[howmanyEnemy].animations.play('walk');
							
							
							if(wichWorld==2) enemy[howmanyEnemy].animations.add('walk',[0,1,2,3,4], 5 /*fps */, true);
							if(wichWorld==2) enemy[howmanyEnemy].animations.play('walk');
							
							
							if(wichWorld==3) enemy[howmanyEnemy].animations.add('walk',[0,1], 5 /*fps */, true);
							if(wichWorld==3) enemy[howmanyEnemy].animations.play('walk');
							
							if(wichWorld==4) enemy[howmanyEnemy].animations.add('walk',[0,1,2,3,4,5], 9 /*fps */, true);
							if(wichWorld==4) enemy[howmanyEnemy].animations.play('walk');
							
							if(wichWorld==5) enemy[howmanyEnemy].animations.add('walk',[0,1], 5 /*fps */, true);
							if(wichWorld==5) enemy[howmanyEnemy].animations.play('walk');
							
							
							enemy[howmanyEnemy].checkWorldBounds = true;
					    		enemy[howmanyEnemy].outOfBoundsKill = true;
					    		 //tween = game.add.tween(enemy[howmanyEnemy]).to( { y: 220 }, 2000, Phaser.Easing.Bounce.InOut, true);
					    		if(wichWorld==1)  tween = game.add.tween(enemy[howmanyEnemy]).to({y: 220}, 1000, Phaser.Easing.Quadratic.In) // drop down to y = 220
							  .to({y: 50}, 1000, Phaser.Easing.Quadratic.Out) // bounce back up to y = 10
							  .loop().start();
							  
							if(wichWorld==2)  tween = game.add.tween(enemy[howmanyEnemy]).to({y: 220}, 1000, Phaser.Easing.Quadratic.In) // drop down to y = 220
							  .to({y: 180}, 1000, Phaser.Easing.Quadratic.Out) // bounce back up to y = 10
							  .loop().start();
					    		console.log(howmanyEnemy);
					    		
					    		
					    		if(wichWorld==3)  tween = game.add.tween(enemy[howmanyEnemy]).to({y: 220}, 1000, Phaser.Easing.Quadratic.In) // drop down to y = 220
							  .to({y: 50}, 1000, Phaser.Easing.Quadratic.Out) // bounce back up to y = 10
							  .loop().start();
							  
							if(wichWorld==4)  tween = game.add.tween(enemy[howmanyEnemy]).to({y: 220}, 1000, Phaser.Easing.Quadratic.In) // drop down to y = 220
							  .to({y: 160}, 1000, Phaser.Easing.Quadratic.Out) // bounce back up to y = 10
							  .loop().start();
					    		console.log(howmanyEnemy);
					    		
					    		if(wichWorld==5)  tween = game.add.tween(enemy[howmanyEnemy]).to({y: 220}, 1000, Phaser.Easing.Quadratic.In) // drop down to y = 220
							  .to({y: 50}, 1000, Phaser.Easing.Quadratic.Out) // bounce back up to y = 10
							  .loop().start();
					    		
					    		
					    		howmanyEnemy+=1;
					    		//console.log(howmanyEnemy);
				    		}
				    		else howmanyEnemy=0;
			    		
			    		}
				   }
				   , this);   
				   
				
				
				//We manage enemies2
				game.time.events.loop(4500, function () {
	   				
	   				if(step==2){
	   				
		   				enemy2 = enemies2.getFirstExists(false);

						if (enemy2)
						{
						    //  And fire it
						    
						    //Step0
						    //bullet.reset(character.x+40, character.y);
						    //bullet.body.velocity.x = 400;

						    
						    //Step1
						    //var yUpDown = (character.y) + game.rnd.between(-20, 20);
						    //bullet.reset(character.x+40, yUpDown);
						    if(wichWorld==1) enemy2.animations.add("idle", [0,1], 4, true);
						    if(wichWorld==1) enemy2.reset(610, character.y+65);
						    
						    if(wichWorld==2) enemy2.animations.add("idle", [0,1,2,3,4,5], 5, true);
						    if(wichWorld==2) enemy2.reset(610, character.y+85);
						    
						    if(wichWorld==3) enemy2.animations.add("idle", [0], 2, true);
						    if(wichWorld==3) enemy2.reset(610, character.y+65);
						    
						    if(wichWorld==4) enemy2.animations.add("idle", [0,1,2,3,4,5], 9, true);
						    if(wichWorld==4) enemy2.reset(610, character.y+85);
						    
						    if(wichWorld==5) enemy2.animations.add("idle", [0], 2, true);
						    if(wichWorld==5) enemy2.reset(640, character.y+85);
						    
						    
						    if(tablet==1) enemy2.body.velocity.x = -200;
						    else enemy2.body.velocity.x = -90;
						    
						    
						    
						    enemy2.animations.play("idle");
						    //enemy2.bringToTop();
						    
						    
			    
			    
						    
						    
						}
					
					}
				   }
				   , this);
				   
				//We manage enemies3
				game.time.events.loop(5500, function () {
	   				if(step==2){
	   				
		   				if(howmanyEnemy<=10){
					   		enemyGamma[howmanyenemyGamma] = game.add.sprite(610, 0, 'enemyGamma');
							game.physics.arcade.enable(enemyGamma[howmanyenemyGamma]);
							enemyGamma[howmanyenemyGamma].enableBody = true;
							enemyGamma[howmanyenemyGamma].anchor.setTo(0.5, 0.5);
							
							if(tablet==1) enemyGamma[howmanyenemyGamma].body.velocity.x = -250;
							else enemyGamma[howmanyenemyGamma].body.velocity.x = -150;
							
							if(wichWorld==1) enemyGamma[howmanyenemyGamma].animations.add('walk',[1,0], 1 /*fps */, true);
							if(wichWorld==1) enemyGamma[howmanyenemyGamma].animations.play('walk');
							
							
							if(wichWorld==3) enemyGamma[howmanyenemyGamma].animations.add('walk',[1,0], 3 /*fps */, true);
							if(wichWorld==3) enemyGamma[howmanyenemyGamma].animations.play('walk');
							
							if(wichWorld==5) enemyGamma[howmanyenemyGamma].animations.add('walk',[1,0], 3 /*fps */, true);
							if(wichWorld==5) enemyGamma[howmanyenemyGamma].animations.play('walk');
							
							
							enemyGamma[howmanyenemyGamma].checkWorldBounds = true;
					    		enemyGamma[howmanyenemyGamma].outOfBoundsKill = true;
					    		 //tween = game.add.tween(enemy[howmanyEnemy]).to( { y: 220 }, 2000, Phaser.Easing.Bounce.InOut, true);
					    		 tween = game.add.tween(enemyGamma[howmanyenemyGamma]).to({y: 240}, 1000, Phaser.Easing.Quadratic.In) // drop down to y = 220
							  .to({y: 190}, 1000, Phaser.Easing.Quadratic.Out) // bounce back up to y = 10
							  .loop().start();
					    		console.log(howmanyenemyGamma);
					    		enemyGamma[howmanyenemyGamma].bringToTop();
					    		howmanyenemyGamma+=1;
					    		//console.log(howmanyEnemy);
					    		
					    		
					    		
				    		}
				    		else howmanyenemyGamma=0;
			    		}
				   }
				   , this);
					
			}
			
			function onUpdate(){
				
				
				
				//Start step=0
				if(step==0){
					
					//Actually we do nothing
					//because all i manged using the 
					//PLAY button
					//but in the future.......
					
					//If just dead,werestore all settings
					if(death==2){
					
						
						//Re-open the same file is the simplest way to reset the game
						if(deathTimer <= game.time.now){
							if(points>localStorage["score"]) localStorage["score"]=points;
							var val = {};
							val.score = points;

						}
					}
				
				}
				//End step=0
				
				//Start step=1
				if(step==1){
				
					title.x=-1000;
					myscore.x=-1000;
					playbutton.x=-1000;
					preferencesbutton.x=-1000;
					creditsbutton.x=-1000
					bkgmenu.x=-1000;
					windowmenu.x=-1000;
					
					character.x=100;
					character.y=175;
					character.animations.play('run');

					step=2;
				}
				
				//Start step=2
				if(step==2){
					//The bullets
					//bullet = bullets.getFirstExists(false);
					//bullet = bullets.getFirstDead();
					//bullet.revive();
				
					
					exitbutton.bringToTop();
					
					
					//  Scroll the background (if still alive)
	    				//starfield.tilePosition.x -= 0.5;
	    				if(death==0) starfield.tilePosition.x -= 1.5;
	    				else{ 
	    					if(death==1){ character.animations.play('dead');
		    					if(character.animations.currentAnim.frame==8){ 
		    						character.animations.play('finaldead');
		    						death=2;
		    						step=0;
		    					}
		    					deathTimer = game.time.now + 2000;
	    					}
	    				}
				
				
					if((character.animations.currentAnim.frame==27 && wichChar<=1)||(character.animations.currentAnim.frame==30 && wichChar>=2)){
		 				/*bullet = bullets.getFirstExists(false);
		 				if (bullet)
						{
						
							bullet.reset(character.x+40, character.y);
						 	bullet.body.z=1;
						 	bullet.body.y=character.y-26;
						 	bullet.body.velocity.x = 800;
						}*/
						/*
						bullets[manyBullets] = game.add.sprite(character.x+40, character.y, 'bullet');
						game.physics.arcade.enable(bullets[manyBullets]);
						bullets[manyBullets].enableBody = true;
						bullets[manyBullets].anchor.setTo(0.5, 0.5);
						bullets[manyBullets].body.y=character.y-26;
						bullets[manyBullets].body.velocity.x = 800;
						bullets[manyBullets].checkWorldBounds = true;
				    		bullets[manyBullets].outOfBoundsKill = true;
				    		
				    		if(manyBullets==20){
							manyBullets=1;
						} else{
							manyBullets+=1;
						}*/
					
						bump.play('',0,1,false);
						
						//attackshot.play('',0,1,false);
						
						if(quantiCancello==2){
							//  Grab the first bullet we can from the pool
							bullet = bullets.getFirstExists(false);
							
							

							if (bullet)
							{
							    //  And fire it
							    
							    //Step0
							    //bullet.reset(character.x+40, character.y);
							    //bullet.body.velocity.x = 400;

							    
							    //Step1
							    //var yUpDown = (character.y) + game.rnd.between(-20, 20);
							    //bullet.reset(character.x+40, yUpDown);
							    
							    bullet.reset(character.x+40, character.y);
							    bullet.body.velocity.x = 400;
							    
							    
							}
						}
						if(quantiCancello==5){
							//  Grab the first bullet we can from the pool
							monster2 = monsters2.getFirstExists(false);
							
							//bump.play('',0,1,false);

							if (monster2)
							{
							    //  And fire it
							    
							    //Step0
							    //bullet.reset(character.x+40, character.y);
							    //bullet.body.velocity.x = 400;

							    
							    //Step1
							    //var yUpDown = (character.y) + game.rnd.between(-20, 20);
							    //bullet.reset(character.x+40, yUpDown);
							    if(wichChar==1) monster2.animations.add("idle", [0,1], 7, true);
							    if(wichChar==0) monster2.animations.add("idle", [0,1,2,3,4], 7, true);
							    monster2.reset(character.x+40, character.y+30);
							    
							    if(tablet==1) monster2.body.velocity.x = 300;
							    else  monster2.body.velocity.x = 200;
							    
							    if(wichChar==1) monster2.animations.play("idle");
							    if(wichChar==0) monster2.animations.play("idle");
							    
							}
						}
						if(quantiCancello==6){
							//  Grab the first bullet we can from the pool
							monster1 = monsters1.getFirstExists(false);
							
							yahoo.play('',0,1,false);

							if (monster1)
							{
							    //  And fire it
							    
							    //Step0
							    //bullet.reset(character.x+40, character.y);
							    //bullet.body.velocity.x = 400;

							    
							    //Step1
							    //var yUpDown = (character.y) + game.rnd.between(-20, 20);
							    //bullet.reset(character.x+40, yUpDown);
							    if(wichChar==1) monster1.animations.add("idle", [0,1,2,3,4,5,6,7,6,5,4,3,2,1], 10, true);
							    if(wichChar==0) monster1.animations.add("idle", [0,1,2,3,4], 10, true);
							    monster1.reset(character.x+40, character.y);
							    
							    if(tablet==1) monster1.body.velocity.x = 500;
							    else monster1.body.velocity.x = 500;
							    
							    if(wichChar==1) monster1.animations.play("idle");
							    if(wichChar==0) monster1.animations.play("idle");
							    
							    
							    
				    
				    
							    
							    
							}
						}
						if(quantiCancello>6){
							//  Grab the first bullet we can from the pool
							
							yahoo.play('',0,1,false);
						
							for(r=1;r<=7;r++){
						
								monster4 = monsters4.getFirstExists(false);

								if (monster4)
								{
								    //  And fire it
								    
								    //Step0
								    //bullet.reset(character.x+40, character.y);
								    //bullet.body.velocity.x = 400;

								    
								    //Step1
								    //var yUpDown = (character.y) + game.rnd.between(-20, 20);
								    //bullet.reset(character.x+40, yUpDown);
								    if(wichChar==1) monster4.animations.add("idle", [0,1], 7, true);
								    if(wichChar==0) monster4.animations.add("idle", [0,1,2,3,4], 10, true);
								    monster4.reset(character.x+40, incrPosMonster4);
								    
								    if(tablet==1) monster4.body.velocity.x = 500;
								    else monster4.body.velocity.x = 500;
								    
								    if(wichChar==1) monster4.animations.play("idle");
								    if(wichChar==0) monster4.animations.play("idle");
								    
									    
								    
								}
							
								incrPosMonster4+=30;
							}
							incrPosMonster4=20;
						
						}
						if((quantiCancello>=3)&&(quantiCancello<=4)){
							//  Grab the first bullet we can from the pool
							
							//bump.play('',0,1,false);
						
							if(howmanyMonster3<=10){
						   		/*
						   		monster3[howmanyMonster3] = game.add.sprite(character.x+40, character.y, 'monster3');
								game.physics.arcade.enable(monster3[howmanyMonster3]);
								monster3[howmanyMonster3].enableBody = true;
								*/
								monster3[howmanyMonster3].reset(character.x+40, character.y+30);
								monster3[howmanyMonster3].anchor.setTo(0.5, 0.5);
								
								if(tablet==1) monster3[howmanyMonster3].body.velocity.x = 150;
								else monster3[howmanyMonster3].body.velocity.x = 50;
								
								if(wichChar==1) monster3[howmanyMonster3].animations.add("idle", [0,1,2,3,4,5,6,7,6,5,4,3,2,1], 10, true);
								if(wichChar==1) monster3[howmanyMonster3].animations.play('idle');
								
								if(wichChar==0) monster3[howmanyMonster3].animations.add("idle", [0,1,2,3,4], 10, true);
								if(wichChar==0) monster3[howmanyMonster3].animations.play('idle'); 
								
								monster3[howmanyMonster3].checkWorldBounds = true;
						    		monster3[howmanyMonster3].outOfBoundsKill = true;
						    		 //tween = game.add.tween(enemy[howmanyEnemy]).to( { y: 220 }, 2000, Phaser.Easing.Bounce.InOut, true);
						    		 /*tween = game.add.tween(monster3[howmanyMonster3]).to({y: 220}, 1000, Phaser.Easing.Quadratic.In,0) // drop down to y = 220
								  .to({y: 20}, 1000, Phaser.Easing.Quadratic.Out,0) // bounce back up to y = 10
								  .loop(2)
								  .start();
								  */
								  tween = game.add.tween(monster3[howmanyMonster3]).to({y: 50}, 1000, Phaser.Easing.Quadratic.In,true,0,12,true);
						    		//console.log(howmanyEnemy);
						    		howmanyMonster3+=1;
						    		//console.log(howmanyEnemy);
					    		}
					    		else howmanyMonster3=0;
						
						
						
						
						
						}
					
					
						quantiCancello=0;
					}
			
			
					if((flagAttack==1)&&(death==0)){
						//console.log('flagAttackpos2'+flagAttack);
						if(wichChar<=1){
							if(character.animations.currentAnim.frame==26 || character.animations.currentAnim.frame==1 || character.animations.currentAnim.frame==29 && quantiCancello<1){
								//character.animations.play('idle');
								character.animations.play('run');
								flagAttack=0;
								//console.log('flagAttackpos3'+flagAttack);
							}
						}
						else if(wichChar>=2){
							if(character.animations.currentAnim.frame==29 || character.animations.currentAnim.frame==1 || character.animations.currentAnim.frame==39 && quantiCancello<1){
								//character.animations.play('idle');
								character.animations.play('run');
								flagAttack=0;
								//console.log('flagAttackpos3'+flagAttack);
							}
						}
				
				
				
				
				
					}
				
				
				
				
					//Enemy2
					game.physics.arcade.overlap(enemies2, bullets, function(alfa, beta) {
						
						getExplosion(beta.x, beta.y);
						alfa.kill();
						beta.kill();
						managePoints(5);

					}, null, this);
				
				
					game.physics.arcade.overlap(enemies2, monsters1, function(alfa, beta) {
			
						getExplosion(beta.x, beta.y);
						alfa.kill();
						//beta.kill();
						managePoints(5);

					}, null, this);
				
					game.physics.arcade.overlap(enemies2, monsters2, function(alfa, beta) {
			
						getExplosion(beta.x, beta.y);
						alfa.kill();
						beta.kill();
						managePoints(5);

					}, null, this);
				
				
					game.physics.arcade.overlap(enemies2, monsters4, function(alfa, beta) {
			
						getExplosion(beta.x, beta.y);
						alfa.kill();
						beta.kill();
						managePoints(5);

					}, null, this);
				
					for(m=0;m<=10;m++){
					
						var actualMonster3=monster3[m];
					
						game.physics.arcade.overlap(enemies2, actualMonster3, function(alfa, beta) {
			
							getExplosion(beta.x, beta.y);
						
						
							alfa.kill();
							beta.kill();
							managePoints(5);

						}, null, this);
					}
				
					game.physics.arcade.overlap(enemies2, character, function(beta,alfa) {
						if(Math.abs(alfa.x-beta.x)<40){
						
							//If melee
							if(wichChar<=1 && character.animations.currentAnim.frame>=20 && character.animations.currentAnim.frame<=26){
						
								getExplosion(alfa.x, alfa.y);
								alfa.kill();
								managePoints(5);
						
							
								flagAttack=1;

								//beta.kill();
							}
							else if(wichChar>=2 && character.animations.currentAnim.frame>=20 && character.animations.currentAnim.frame<=29){
						
								getExplosion(alfa.x, alfa.y);
								alfa.kill();
								managePoints(5);
						
							
								flagAttack=1;

								//beta.kill();
							}
							else{
								if(death==0) getExplosion(alfa.x, alfa.y);
								if(death==0) alfa.kill();
								/*
								//Jelly del character
								game.juicy.jelly(beta);
								//Lo shake
								game.juicy.shake();
								//Un flash dello sfondo delle gemme (il flash dello schermo necessita che non vi sia uno 
								//sfondo disegnato ma un colore di base)
								game.screenFlash.flash(1,100);
								*/
								//The damage
								manageEnergy(0.05);
						
								if(death==0) character.animations.play('ouch');
								flagAttack=1;

								//beta.kill();
							}
						}

					}, null, this);
				
				
				
				
					//Enemy1
					//if(howmanyEnemy>=1){
						for(i=0;i<=30;i++){
					
							var actualEnemy=enemy[i];
					
							//for(u=1;u<=20;u++){
					
								//var actualBullet=bullets[u];
								game.physics.arcade.overlap(actualEnemy, bullets, function(alfa, beta) {
						
									getExplosion(beta.x, beta.y);
									alfa.kill();
									beta.kill();
									managePoints(5);

								}, null, this);
							
							
								game.physics.arcade.overlap(actualEnemy, monsters1, function(alfa, beta) {
						
									getExplosion(beta.x, beta.y);
									alfa.kill();
									//beta.kill();
									managePoints(5);

								}, null, this);
							
								game.physics.arcade.overlap(actualEnemy, monsters2, function(alfa, beta) {
						
									getExplosion(beta.x, beta.y);
									alfa.kill();
									beta.kill();
									managePoints(5);

								}, null, this);
							
							
								game.physics.arcade.overlap(actualEnemy, monsters4, function(alfa, beta) {
						
									getExplosion(beta.x, beta.y);
									alfa.kill();
									beta.kill();
									managePoints(5);

								}, null, this);
							
								for(m=0;m<=10;m++){
								
									var actualMonster3=monster3[m];
								
									game.physics.arcade.overlap(actualEnemy, actualMonster3, function(alfa, beta) {
						
										getExplosion(beta.x, beta.y);
									
									
										alfa.kill();
										beta.kill();
										managePoints(5);

									}, null, this);
								}
							
								game.physics.arcade.overlap(actualEnemy, character, function(alfa, beta) {
									if(Math.abs(alfa.x-beta.x)<40){
									
										//If melee
										if(wichChar<=1 && character.animations.currentAnim.frame>=20 && character.animations.currentAnim.frame<=26){
						
											getExplosion(alfa.x, alfa.y);
											alfa.kill();
											managePoints(5);
						
							
											flagAttack=1;

											//beta.kill();
										}
										else if(wichChar>=2 && character.animations.currentAnim.frame>=20 && character.animations.currentAnim.frame<=29){
						
											getExplosion(alfa.x, alfa.y);
											alfa.kill();
											managePoints(5);
						
							
											flagAttack=1;

											//beta.kill();
										}
										else{
											if(death==0) getExplosion(alfa.x, alfa.y);
											if(death==0) alfa.kill();
											/*
											//Jelly del character
											game.juicy.jelly(beta);
											//Lo shake
											game.juicy.shake();
											//Un flash dello sfondo delle gemme (il flash dello schermo necessita che non vi sia uno 
											//sfondo disegnato ma un colore di base)
											game.screenFlash.flash(1,100);
											*/
											//The damage
											manageEnergy(0.05);
											if(death==0) character.animations.play('ouch');
											flagAttack=1;

											//beta.kill();
										}
									}

								}, null, this);
							
							
						
							//}
						}
					//}
					//End enemy1
				
				
				
				
				
				
					//Enemy3
					for(i=0;i<=10;i++){
				
						var actualenemyGamma=enemyGamma[i];
				
						//for(u=1;u<=20;u++){
				
							//var actualBullet=bullets[u];
							game.physics.arcade.overlap(actualenemyGamma, bullets, function(alfa, beta) {
					
								getExplosion(beta.x, beta.y);
								alfa.kill();
								beta.kill();
								managePoints(5);

							}, null, this);
						
						
							game.physics.arcade.overlap(actualenemyGamma, monsters1, function(alfa, beta) {
					
								getExplosion(beta.x, beta.y);
								alfa.kill();
								//beta.kill();
								managePoints(5);

							}, null, this);
						
							game.physics.arcade.overlap(actualenemyGamma, monsters2, function(alfa, beta) {
					
								getExplosion(beta.x, beta.y);
								alfa.kill();
								beta.kill();
								managePoints(5);

							}, null, this);
						
						
							game.physics.arcade.overlap(actualenemyGamma, monsters4, function(alfa, beta) {
					
								getExplosion(beta.x, beta.y);
								alfa.kill();
								beta.kill();
								managePoints(5);

							}, null, this);
						
							for(m=0;m<=10;m++){
							
								var actualMonster3=monster3[m];
							
								game.physics.arcade.overlap(actualenemyGamma, actualMonster3, function(alfa, beta) {
					
									getExplosion(beta.x, beta.y);
								
								
									alfa.kill();
									beta.kill();
									managePoints(5);

								}, null, this);
							}
						
							game.physics.arcade.overlap(actualenemyGamma, character, function(alfa, beta) {
								if(Math.abs(alfa.x-beta.x)<40){
								
									//If melee
									if(wichChar<=1 && character.animations.currentAnim.frame>=20 && character.animations.currentAnim.frame<=26){
						
										getExplosion(alfa.x, alfa.y);
										alfa.kill();
										managePoints(5);
						
							
										flagAttack=1;

										//beta.kill();
									}
									else if(wichChar>=2 && character.animations.currentAnim.frame>=20 && character.animations.currentAnim.frame<=29){
						
										getExplosion(alfa.x, alfa.y);
										alfa.kill();
										managePoints(5);
						
							
										flagAttack=1;

										//beta.kill();
									}
									else{
										if(death==0) getExplosion(alfa.x, alfa.y);
										if(death==0) alfa.kill();
										/*
										//Jelly del character
										game.juicy.jelly(beta);
										//Lo shake
										game.juicy.shake();
										//Un flash dello sfondo delle gemme (il flash dello schermo necessita che non vi sia uno 
										//sfondo disegnato ma un colore di base)
										game.screenFlash.flash(1,100);
										*/
										//The damage
										manageEnergy(0.05);
										if(death==0) character.animations.play('ouch');
										flagAttack=1;

										//beta.kill();
									}
								}

							}, null, this);
						
						
					
						//}
					}
					//}
					//End enemy3
				
				
					//We can pick tiles only if we are still alive and inside the match/tiles area!
					if(death==0 && game.input.worldY >= 300) game.input.onDown.add(pickTile, this);	
					console.log('game.input.worldY'+game.input.worldY);
				
				
				}
				//End step=2
			}

			
			
			function getExplosion (x, y) {
			    // Get the first dead explosion from the explosionGroup
			    //  And create an explosion :)
			    var explosion = explosions.getFirstExists(false);
			    var animation = explosion.animations.add("explosion", [0,1,2,3], 60, false);
			    animation.killOnComplete = true;
			    explosion.reset(x, y);
			    // Play the animation
			    explosion.animations.play("explosion");

			    // Return the explosion itself in case we want to do anything else with it
			    return explosion;
			};
			
			
			
			// a tile has been picked
			function pickTile(){
				
				//We can pick tiles only if we are still alive and inside the match/tiles area!
				if(death==0 && game.input.worldY >= 300){
					quantiCancello=0;
				
					// save input coordinates
					startX = game.input.worldX;
					startY = game.input.worldY;
					// retrieve selected row and column 
					selectedRow = Math.floor(startY/tileSize)-(shifter/tileSize);
					selectedCol = Math.floor(startX/tileSize);
					// delete using flood fill
					console.log('frame usato: '+tileArray[selectedRow][selectedCol].frame); //0=blu, 1=rosso, 2=verde
					floodFill(selectedRow,selectedCol,tileArray[selectedRow][selectedCol].frame);
					//console.log(tileArray[selectedRow][selectedCol].frame);
					console.log('quantiCancello: '+quantiCancello);
				
					if(quantiCancello<=1){
						game.juicy.shake();
						character.animations.play('melee');
						flagAttack=1;
						
						attackshot.play('',0,1,false);
						//console.log('flagAttack'+flagAttack);
					}
					if(quantiCancello>1){
						game.juicy.shake();
						character.animations.play('shot');
						
						attackshot.play('',0,1,false);
					
						//bullet = bullets.getFirstExists(false);
		 				/*
						if (bullet)
						{
							bullet.reset(character.x, character.y);
						 	bullet.body.z=1;
						 	bullet.body.y=character.y-26;
						 	bullet.body.velocity.x = 800;
						}*/
						/*if(quantiCancello==3) 
						if(quantiCancello==4) character.animations.play('shotb');
						if(quantiCancello>=5) character.animations.play('shotc');
						*/
						flagAttack=1;
					}
				
				
				
					// make existing gems fall down
					fallDown();
					// replenish game field from the top 
					fallFromTop();
					//quantiCancello=0;
				
				
				
					managePoints(quantiCancello*5);
				}
			}
			
			// flood fill function. There is an entire post about it at http://bit.ly/1BsyiOd
               function floodFill(row,col,val){
				if(row>=0 && row<fieldSizeB && col>=0 && col<fieldSize){
				
					if(tileArray[row][col]!=null && tileArray[row][col].frame==val){
						tileArray[row][col].destroy();
						tileArray[row][col]=null;
						floodFill(row+1,col,val);
					         floodFill(row-1,col,val);
					         floodFill(row,col+1,val);
					         floodFill(row,col-1,val);
					         quantiCancello+=1;
					}
					
				
				}	
			}
			
               // function to make remaining tiles fall down once you removed tiles
			function fallDown(){
				for(var i=fieldSizeB-1;i>=0;i--){
					for(var j=0;j<fieldSize;j++){
						if(tileArray[i][j]!=null){
		                         var delta = holesBelow(i,j);
		                         if(delta>0){
		                         	//console.log(delta)
		                         	var tileTween = game.add.tween(tileArray[i][j]);
								tileTween.to({
									y: ((i+delta)*tileSize+tileSize/2)+shifter
								},800,Phaser.Easing.Cubic.Out,true);
		                              tileArray[i+delta][j]=tileArray[i][j];
	                              	tileArray[i][j]=null;
		                         }
						}	
					}
				}
			}
			
			// function to add new tiles falling from the top
               function fallFromTop(){
				for(i=0;i<fieldSize;i++){
					var holes = holesBelow(-1,i);
					for(j=0;j<holes;j++){
						var randomTile = Math.floor(Math.random()*tileTypes);
						var tileXPos = i*tileSize+tileSize/2;
						var tileYPos = -((holes-j)*tileSize-tileSize/2);
						var theTile = game.add.sprite(tileXPos,tileYPos+shifter,"tiles");
						theTile.frame = randomTile;
						theTile.anchor.setTo(0.5,0.5);
						tileArray[j][i]=theTile;		
	                    	tileTween = game.add.tween(tileArray[j][i]);
						tileTween.to({
							y: (j*tileSize+tileSize/2)+shifter
						},800,Phaser.Easing.Cubic.Out,true);	
					}
				}
			}
			
               // given a row and a column position, returns how may holes (empty places) we have under such position
			function holesBelow(row,col){
				var holes = 0;
				for(var i=row+1;i<fieldSizeB;i++){
					if(tileArray[i][col]==null){
						holes++;
					}		
				}
				return holes;				
			}
			           
		</script>
    </head>
    <body bgcolor="#000000">
    </body>

</html>
